<%- content_for :javascript do %>
<%= raw javascript_include_tag('jquery.lightbox-0.5.min.js', :charset => 'utf-8') %>
<%- end %>
<%- content_for :stylesheets do %>
<%= stylesheet_link_tag 'jquery.lightbox-0.5.css'  %>
<%- end %>

<script>
	var campaign_data = {
		title: "<%= @campaign.title %>",
		id: <%= @campaign.id %>,
		url: document.location.protocol + '//' + document.location.host + "<%= campaign_path(@campaign) %>",
		description: "<%= @campaign.description %>"
	};
</script>
<%- if (current_user && current_user.supporter_or_initiator(@campaign)) || @campaign.status == :successful %>
  <div id="banner" class="<%= 'supporter' %>">
  	<div class="container">
  		<h1>
  		  <%- if current_user && current_user == @campaign.initiator %>
  		  <a href="<%= location_url(@campaign.location) %>"><%= @campaign.short_initiator_call_to_action %></a>
  		  <%- else %>
  		  <a href="<%= location_url(@campaign.location) %>"><%= @campaign.short_call_to_action %></a>
  		  <%- end %>
  		</h1>
  		<div class="right">
  		  <%- if current_user && current_user == @campaign.initiator %>
  			  <span class="status">Your Campaign</span>
  			<%- elsif current_user &&  current_user.supporter_or_initiator(@campaign) %>
  			  <span class="status">You support this</span>
  			<%- end %>
  		<%- if @campaign.status == :successful %>
			<span class="ribbon">Fixed</span>
  		<%- end %>
  		</div>
  	</div>
  </div>
  <%- if current_user && current_user.new_supporter?(@campaign) %>
    <div class="supporter-notice">
      <div class="container">
        <h1>Yay! Thanks for supporting our campaign</h1>
        <p>Offer opinions and advice to help make the campaign a success. <br />And don't forget to tell your friends  and spread the word through Twitter &amp; Facebook</p>
      </div>
    </div>
  <%- end %>
<%- else %>
  <div id="banner" class="yellow container">
  	<div class="leftcol-banner">
  		<h1 class="font-1">&ldquo;<%= @campaign.call_to_action %>&rdquo; &ndash; <%= @campaign.initiator.name %></h1>
  	</div>

  	<div class="rightcol">
      <%= render :partial => 'support_button', :locals => { :button_class => 'support-big', :display_supporter => true, :display_initiator => true } %>
  	</div>
  </div>
<%- end %>
<div id="main-content" class="container">

	<div class="leftcol">
	  	<%- if current_user && current_user == @campaign.initiator %>
      	<%= render :partial => "initiator_buttons" %>
    	<%- end %>

		<div class="box campaign-description">
			<h3>Description</h3>
		  	<%- if (!current_user) || !(current_user.supporter_or_initiator(@campaign)) %>
			<img src="<%= @campaign.initiator.profile_photo.url(:small_thumb) %>" class="avatar" />
			<%- end %>
			<div>
				<%- if !current_user || !(current_user.supporter_or_initiator(@campaign)) %>
				<h4><a href="<%= profile_url(@campaign.initiator) %>"><%= @campaign.initiator.name %></a></h4>
				<%- end %>
          
			
				  <%- if params[:full_description] %> 
				    <%= raw simple_format(sanitize(@campaign.description)) %>
				  <%- else %>
				    <div id="truncated-description">
				    <%= raw simple_format(truncate(sanitize(@campaign.description), :length => 200)) %>
				    </div>
				    <div id="full-description" style="display: none;">
				      <%= raw simple_format(sanitize(@campaign.description)) %>
				    </div>
				  <%- end %>
          <%- if sanitize(@campaign.description).size > 200 and ! params[:full_description] %>
				  <a href="<%= url_for(params.merge(:full_description => '1')) %>" class="more-info">more</a>
				  <%- end %>
			</div>
		</div>


   <%- if current_user && current_user.is_expert? %>

     <div class="clear">
       <h3><%= t(:transport_experts) %></h3>
       <div class='expert-tools'>
         <div class='optional-assignment'>
           <a href="<%= new_campaign_assignment_path(@campaign) %>" class="button"><%= t(:tell_to_write, :user => @campaign.initiator.first_name) %></a>
         </div>
         <div class='optional-assignment'>
           <a href="<%= edit_campaign_path(@campaign)%>" class="button"><%= t(:edit_description) %></a>
         </div>
         <div class='optional-assignment-end'>
         </div>
       </div>
     </div>
   <%- end %>

    <%- if @campaign.campaign_photos.count > 0 %>
		<div class="box">
			<h5>Images and Media</h5>
			<ul class="gallery">
			  <%- @campaign.campaign_photos.each do |campaign_photo| %>
			    <%- if ! campaign_photo.new_record? %>
				    <li>
				      <a href="<%= campaign_photo.image.url(:max) %>"><img src="<%= campaign_photo.image.url(:default) %>" />
				      </a>
				    </li>
				  <%- end %>
				<%- end %>
			</ul>
		</div>
		<%- end %>

		<div class="box">
			<a class="button comment comment-trigger right" href="<%= add_comment_campaign_url(@campaign) %>">Comment</a>
		</div>

		<div class="clear">
			<h3 class='left campaign-history'><%= t(:campaign_history) %></h3>
			<div class="thread-controls">
				<a href="#" class="expand-all">Expand All</a>
				<a href="#" class="collapse-all">Collapse All</a>
			</div>
		</div>
		<ul id="campaign-thread">
		<%- @event_index = 1 %>
		<%- @campaign.campaign_events.visible.each do |campaign_event| %>
		  <%- if !campaign_event.described.respond_to?(:visible?) or campaign_event.described.visible? %>
			<%= render :partial => 'campaign_event', :locals => { :event => campaign_event, :index => @event_index } %>
			<%- @event_index += 1%>
			<%- end %>
		<%- end %>
		</ul>

    <%= render :partial => 'support_button', :locals => { :button_class => 'right support', :display_supporter => false, :display_initiator => false } %>

	</div>


	<div class="rightcol">
		<%- if current_user && current_user.new_supporter?(@campaign) %>
	    <div class="contrib-tools-initial">
			<a href="#" class="facebook-trigger">
				<span class="icon facebook"></span>
				Facebook
			</a>
			<a href="<%= twitter_url(@campaign) %>" target="_blank" class="twitter-popup">
				<span class="icon twitter"></span>
				Twitter
			</a>
			<a href="#">
				<span class="icon grey email"></span>
				Email
			</a>
	    </div>
	  <%- end %>

	  <%- if current_user && current_user.supporter_or_initiator(@campaign) && ! current_user.new_supporter?(@campaign) %>
		<div class="contrib-tools">
			<a href="#" class="facebook-trigger">
				<span class="icon facebook"></span>
				Facebook
			</a>
			<a href="<%= twitter_url(@campaign) %>" target="_blank" class="twitter-popup">
				<span class="icon twitter"></span>
				Twitter
			</a>
			<a href="#">
				<span class="icon grey email"></span>
				Email
			</a>
		</div>
		<%- end %>

		<ul class="campaign-meta">
			<li>started <span><%= @campaign.created_at.strftime("%e %B %Y") %></span></li>
			<li>supporters <%=  @campaign.supporter_count %></li>
		</ul>

		<%- if @campaign.location %>
		<div id="map-container">
			<div id="small-map">
			  <h5><%= @campaign.location.description %></h5>
			  <%= render :partial => 'shared/map', :locals => { :locations => [@campaign.location], :other_locations => [], :link_type => :location, :height => CAMPAIGN_PAGE_MAP_HEIGHT, :width => CAMPAIGN_PAGE_MAP_WIDTH, :static => true } %>
			</div>
			<a class="button grey right" href="<%= location_url(@campaign.location) %>">Larger Map</a>
		</div>
		<%- end %>


		<div class="box">
			<h5>Campaign Manager</h5>
			<div class="greybox">
				<div class="avatar"><img src="<%= @campaign.initiator.profile_photo.url(:large_thumb) %>" /></div>
				<div class="user-info">
					<a class="name" href="<%= profile_url(@campaign.initiator) %>"><%= @campaign.initiator.name %></a>
					<%- if @campaign.initiator.location %>
					<p class="location"><%= @campaign.initiator.location %></p>
					<%- end %>
					<p>Managing <a href="<%= profile_url(@campaign.initiator, :anchor => "managing") %>"><%= pluralize(@campaign.initiator.initiated_campaigns.count, 'Campaign') %></a></p>
					<p>Supporting <a href="<%= profile_url(@campaign.initiator, :anchor => "supporting") %>"><%= pluralize(@campaign.initiator.campaigns.count, 'Campaign') %></a></p>
				</div>
			</div>
		</div>

		<%- if @campaign.supporters.registered.count > 0 %>
		  <%= render :partial => "supporters", :locals => {:show_all => (params[:all_supporters] == '1') }%>
		<%- end %>

		<%- if current_user && current_user.supporter_or_initiator(@campaign) && ! current_user.new_supporter?(@campaign) %>
		    <div>
			    <fb:like href="<%= campaign_url(@campaign) %>" send="false" width="310" show_faces="true" action="recommend" font=""></fb:like>
			</div>
		<%- end %>
		
	</div>

	<div class="container">
		<a href="#top" class="goto-top right">Top of page</a>
	</div>
</div>
